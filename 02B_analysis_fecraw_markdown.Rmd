---
title: "GA Senate Runoffs"
author: "Aaron Kessler & Bill Allison"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    # code_download: true
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(janitor)
library(plotly)
library(widgetframe)
library(scales)
library(zoo)
library(summarytools)
options(dplyr.summarise.inform = FALSE)
```


```{r dataload, include=FALSE, cache=TRUE}
#load data files created in step 01
actblue_contribs <- readRDS("processed_data/actblue_fecraw_contribs_postelex_GASEN.rds")
winred_contribs <- readRDS("processed_data/winred_fecraw_contribs_postelex_GASEN.rds")


#ensure that nothing slipped through during processing and we're just looking at 
#individual earmarked contributions
actblue_contribs <- actblue_contribs %>% 
  filter(
    entity_type == "IND", # only individual contributions
    is.na(memo_code), # remove memo lines
    contribution_purpose_descrip == "Earmark" # remove donations that are not for a specific candidate
  )

winred_contribs <- winred_contribs %>% 
  filter(
    entity_type == "IND", # only individual contributions
    is.na(memo_code), # remove memo lines
  )




```



## Totals

Actblue

```{r}

actblue_contribs %>% 
  group_by(ga_candidate) %>% 
  summarise(total_dollars = sum(contribution_amount), avg_amount = mean(contribution_amount), median_amount = median(contribution_amount)) 

```

WinRed
```{r}
winred_contribs %>% 
  group_by(ga_candidate) %>% 
  summarise(total_dollars = sum(contribution_amount), avg_amount = mean(contribution_amount), median_amount = median(contribution_amount)) 

```

###
## In-State vs. Out-of-State
  
  
**Dem overall totals**
```{r}

dem_inout <- actblue_contribs %>% 
  group_by(in_out_state) %>% 
  summarise(total_dollars = sum(contribution_amount)) %>% 
  ungroup()

dem_inout
```

**Dem totals by top states**
```{r}

dem_bystate <- actblue_contribs %>% 
  group_by(contributor_state) %>% 
  summarise(total_dollars = sum(contribution_amount)) %>% 
  arrange(desc(total_dollars)) %>% 
  ungroup() %>% 
  head(15)

dem_bystate
```


**Dem candidate totals**
```{r}

dem_inout_bycand <- actblue_contribs %>% 
  group_by(ga_candidate, in_out_state) %>% 
  summarise(total_dollars = sum(contribution_amount)) %>% 
  ungroup()

dem_inout_bycand


```

```{r}

#chart it out
d <- ggplot(dem_inout, aes(in_out_state, total_dollars)) + geom_col(fill = "darkblue") + coord_flip() +
  theme_minimal()

#add extra elements to the chart and convert to ggplotly
d2 <- d + labs(title = "Dems: In vs. Out of State",
               subtitle = "(Since Nov. 4th)",
               caption = "Source: Bloomberg Analysis, FEC",
               x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=dollar) 

d2





```





```{r}

# The palette:
cbPalette <- c("#508104","#db8200")

d <- ggplot(data = dem_inout_bycand, aes(x = ga_candidate, y = total_dollars, fill = in_out_state)) +
  geom_col(position = "dodge") + coord_flip() + theme_minimal()

d2 <- d + labs(title="Dems Candidates: In vs. Out of State",
               subtitle = "(Since Nov. 4th)",
               caption = "Source: Source: Bloomberg Analysis, FEC",
               x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=dollar) +
  scale_fill_manual(values=cbPalette) +
  theme(legend.title=element_blank())

d2



```


**GOP overall totals**
```{r}

gop_inout <- winred_contribs %>%
  group_by(in_out_state) %>%
  summarise(total_dollars = sum(contribution_amount)) %>%
  ungroup()

gop_inout
```

**GOP totals by top states**
```{r}

gop_bystate <- winred_contribs %>% 
  group_by(contributor_state) %>% 
  summarise(total_dollars = sum(contribution_amount)) %>% 
  arrange(desc(total_dollars)) %>% 
  ungroup() %>% 
  head(15)

gop_bystate
```



**GOP candidate totals**
```{r}

gop_inout_bycand <- winred_contribs %>%
  group_by(ga_candidate, in_out_state) %>%
  summarise(total_dollars = sum(contribution_amount)) %>%
  ungroup()

gop_inout_bycand


```


```{r}

#chart it out
d <- ggplot(gop_inout, aes(in_out_state, total_dollars)) + geom_col(fill = "darkred") + coord_flip() +
  theme_minimal()

#add extra elements to the chart and convert to ggplotly
d2 <- d + labs(title = "Republicans: In vs. Out of State",
               subtitle = "(Since Nov. 4th)",
               caption = "Source: Bloomberg Analysis, FEC",
               x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=dollar)

d2





```





```{r}

# The palette:
cbPalette <- c("#508104","#db8200")

d <- ggplot(data = gop_inout_bycand, aes(x = ga_candidate, y = total_dollars, fill = in_out_state)) +
  geom_col(position = "dodge") + coord_flip() + theme_minimal()

d2 <- d + labs(title="Republican Candidates: In vs. Out of State",
               subtitle = "(Since Nov. 4th)",
               caption = "Source: Source: Bloomberg Analysis, FEC",
               x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels=dollar) +
  scale_fill_manual(values=cbPalette) +
  theme(legend.title=element_blank())

d2



```


## Zip Codes


```{r}
topzips_gop <- winred_contribs %>% 
  mutate(
    zip5 = str_sub(contributor_zip_code, 1, 5)
  ) %>% 
  group_by(zip5) %>% 
  summarise(sumtotal = sum(contribution_amount)) %>% 
  arrange(desc(sumtotal))

topzips_gop


topzips_dem <- actblue_contribs %>% 
  mutate(
    zip5 = str_sub(contributor_zip_code, 1, 5)
  ) %>% 
  group_by(zip5) %>% 
  summarise(sumtotal = sum(contribution_amount)) %>% 
  arrange(desc(sumtotal))

topzips_dem

#write to file
write_csv(topzips_gop, "output/topzips_gop_winred.csv")
write_csv(topzips_dem, "output/topzips_dem_actblue.csv")

```


```{r}
glimpse(winred_contribs)


#write to file
write_csv(topzips_gop, "topzips_gop.csv")
write_csv(topzips_dem, "topzips_dem.csv")


### compare D and R in each zip ####

colnames(topzips_dem) <- c("zip_code", "demtotal")
colnames(topzips_gop) <- c("zip_code", "goptotal")

#join
zipcompare <- full_join(topzips_dem, topzips_gop)

#change nas to 0
zipcompare <- zipcompare %>% 
  replace(., is.na(.), 0)

#party with more
zipcompare <- zipcompare %>% 
  mutate(
    winner = ifelse(demtotal>goptotal, "D", "R"),
    advantage = abs(demtotal-goptotal)  
  )


### bring in the zipcode data table for adding names to zips 
zip_codes_lookup <- read_csv("zip-codes-database-STANDARD.csv")

zip_codes_lookup <- zip_codes_lookup %>% 
  clean_names

zip_codes_lookup <- zip_codes_lookup %>% 
  mutate(
    city = str_to_title(city),
    name = paste0(city, ", ", state),
    zipname = paste0(zip_code, " (", name, ")")
  ) %>% 
  select(zip_code, city, state, zipname)

#remove dups
zip_codes_lookup <- zip_codes_lookup %>% 
  distinct(zip_code, city, state, zipname)


#join to our table
zipcompare <- left_join(zipcompare, zip_codes_lookup)

#save table as rds for later use
saveRDS(zipcompare, "zipcompare.rds")
# save as excel for sharing
writexl::write_xlsx(zipcompare, "output/zipcompare.xlsx")


```


```{r}


```

